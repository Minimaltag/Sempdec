<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cadastro de Famílias</title>
  <link rel="icon" href="favicon.ico" type="image/x-icon" />
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore-compat.js"></script>
  <!-- Bootstrap CSS CDN -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <style>
    * {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }

    body {
      background: #f7f8fa;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      padding: 2rem;
    }

    header {
      margin-bottom: 2rem;
    }

    h1 {
      font-size: 2rem;
      color: #1a1a1a;
      font-weight: 600;
      text-align: center;
    }

    main {
      width: 100%;
      max-width: 900px;
      background: #ffffff;
      padding: 2rem;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    }

    label {
      font-size: 0.95rem;
      color: #333;
      font-weight: 500;
      margin-bottom: 0.5rem;
    }

    input, select {
      text-transform: uppercase;
    }

    input:disabled {
      background: #e5e7eb;
      cursor: not-allowed;
    }

    .localidade-container {
      display: flex;
      gap: 1rem;
      align-items: flex-end;
    }

    .localidade-container select, .localidade-container input {
      flex: 1;
    }

    .cpf-feedback, .secao-feedback, .zona-feedback, .idade-feedback {
      font-size: 0.85rem;
      margin-top: 0.3rem;
      min-height: 1.2rem;
    }

    .cpf-valido, .secao-valido, .zona-valido {
      color: #16a34a;
    }

    .cpf-invalido, .secao-invalido, .zona-invalido {
      color: #dc2626;
    }

    .cpf-duplicado {
      color: #9333ea;
    }

    /* Estilos do Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .modal-content {
      background: #fff;
      padding: 2rem;
      border-radius: 12px;
      width: 100%;
      max-width: 600px;
      max-height: 80vh;
      overflow-y: auto;
      position: relative;
    }

    .modal-content h2 {
      font-size: 1.5rem;
      margin-bottom: 1rem;
    }

    .modal-content input[type="text"] {
      width: 100%;
      margin-bottom: 1rem;
    }

    .comunidade-lista {
      list-style: none;
    }

    .comunidade-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.5rem 0;
      border-bottom: 1px solid #e5e7eb;
    }

    .comunidade-item span {
      flex: 1;
    }

    .comunidade-item button {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 1.2rem;
      padding: 0.5rem;
    }

    .btn-editar {
      color: #2563eb;
    }

    .btn-excluir {
      color: #dc2626;
    }

    .close-modal {
      position: absolute;
      top: 1rem;
      right: 1rem;
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
    }

    /* Estilos da Animação de Carregamento */
    .loading-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .spinner {
      border: 4px solid rgba(255, 255, 255, 0.3);
      border-top: 4px solid #2563eb;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Media Queries para ajustes adicionais */
    @media (max-width: 768px) {
      main {
        padding: 1.5rem;
      }

      h1 {
        font-size: 1.5rem;
      }

      .localidade-container {
        flex-direction: column;
        align-items: stretch;
      }

      .localidade-container button {
        width: 100%;
      }

      .modal-content {
        width: 90%;
        padding: 1.5rem;
      }
    }
  </style>
</head>
<body>
  <script type="module">
    import { auth } from '../../js/firebase-config.js';
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    onAuthStateChanged(auth, (user) => {
      if (!user) {
        window.location.href = "../../index.html";
      }
    });
  </script>
  <header>
    <h1>Cadastro de Famílias</h1>
  </header>
  <main>
    <form class="row g-3">
      <div class="col-md-6">
        <label for="liderFamilia" class="form-label">Líder de Família *</label>
        <input type="text" class="form-control" id="liderFamilia" placeholder="Nome do Líder" required />
      </div>
      <div class="col-md-6">
        <label for="cpfLider" class="form-label">CPF do Líder *</label>
        <input type="text" class="form-control" id="cpfLider" placeholder="000.000.000-00" maxlength="14" inputmode="numeric" pattern="\d*" oninput="mascaraCPF(this)" required />
        <div id="cpfLiderFeedback" class="cpf-feedback"></div>
      </div>
      <div class="col-md-6">
        <label for="numeroContato" class="form-label">Telefone de Contato</label>
        <input type="text" class="form-control" id="numeroContato" placeholder="(00) 00000-0000" maxlength="15" inputmode="numeric" pattern="\d*" oninput="mascaraTelefone(this)" />
      </div>
      <div class="col-md-6">
        <label for="dataNascimentoLider" class="form-label">Data de Nascimento</label>
        <input type="text" class="form-control" id="dataNascimentoLider" placeholder="dd/mm/aaaa" maxlength="10" inputmode="numeric" oninput="mascaraData(this); calcularIdade(this)" />
        <div id="idadeFeedback" class="idade-feedback"></div>
      </div>
      <div class="col-md-6">
        <label for="tituloEleitorLider" class="form-label">Título de Eleitor do Líder *</label>
        <input type="text" class="form-control" id="tituloEleitorLider" placeholder="0000 0000 0000" maxlength="14" inputmode="numeric" pattern="\d*" oninput="mascaraTitulo(this)" required />
      </div>
      <div class="col-md-6">
        <label for="zonaLider" class="form-label">Zona do Líder *</label>
        <input type="text" class="form-control" id="zonaLider" placeholder="0023" maxlength="4" inputmode="numeric" pattern="\d*" oninput="validarZona(this)" required />
        <div id="zonaLiderFeedback" class="zona-feedback"></div>
      </div>
      <div class="col-md-6">
        <label for="secaoLider" class="form-label">Seção do Líder *</label>
        <input type="text" class="form-control" id="secaoLider" placeholder="Seção" maxlength="3" inputmode="numeric" pattern="\d*" oninput="validarSecao(this)" required />
        <div id="secaoLiderFeedback" class="secao-feedback"></div>
      </div>
      <div class="col-md-6">
        <label for="nomeEsposa" class="form-label">Nome do(a) Cônjuge</label>
        <input type="text" class="form-control" id="nomeEsposa" placeholder="Nome do(a) Cônjuge" />
      </div>
      <div class="col-md-6">
        <label for="cpfEsposa" class="form-label">CPF do(a) Cônjuge</label>
        <input type="text" class="form-control" id="cpfEsposa" placeholder="000.000.000-00" maxlength="14" inputmode="numeric" pattern="\d*" oninput="mascaraCPF(this)" />
        <div id="cpfEsposaFeedback" class="cpf-feedback"></div>
      </div>
      <div class="col-md-6">
        <label for="tituloEleitorEsposa" class="form-label">Título de Eleitor do(a) Cônjuge</label>
        <input type="text" class="form-control" id="tituloEleitorEsposa" placeholder="0000 0000 0000" maxlength="14" inputmode="numeric" pattern="\d*" oninput="mascaraTitulo(this)" />
      </div>
      <div class="col-md-6">
        <label for="zonaEsposa" class="form-label">Zona do(a) Cônjuge</label>
        <input type="text" class="form-control" id="zonaEsposa" placeholder="0023" maxlength="4" inputmode="numeric" pattern="\d*" oninput="validarZona(this)" />
        <div id="zonaEsposaFeedback" class="zona-feedback"></div>
      </div>
      <div class="col-md-6">
        <label for="secaoEsposa" class="form-label">Seção do(a) Cônjuge</label>
        <input type="text" class="form-control" id="secaoEsposa" placeholder="Seção" maxlength="3" inputmode="numeric" pattern="\d*" oninput="validarSecao(this)" />
        <div id="secaoEsposaFeedback" class="secao-feedback"></div>
      </div>
      <div class="col-md-6">
        <label for="filhos" class="form-label">Filhos</label>
        <input type="text" class="form-control" id="filhos" placeholder="Número de filhos" maxlength="2" inputmode="numeric" pattern="\d*" oninput="this.value = this.value.replace(/[^0-9]/g, '').slice(0,2)" />
      </div>
      <div class="col-12">
        <label for="localidadeSelect" class="form-label">Comunidade *</label>
        <input type="text" class="form-control mb-2" id="buscaComunidade" placeholder="Buscar comunidade..." />
        <div class="localidade-container">
          <select id="localidadeSelect" class="form-select" required>
            <option value="">Selecione uma comunidade</option>
          </select>
          <input type="text" class="form-control" id="novaLocalidade" placeholder="Nova comunidade" />
          <button type="button" class="btn btn-primary" onclick="adicionarLocalidade()">Adicionar</button>
        </div>
      </div>
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" />
      <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
      <div class="col-12">
        <label for="motivoAuxilio" class="form-label">Motivo do Auxílio *</label>
        <select id="motivoAuxilio" class="form-select" multiple required>
          <option value="Estiagem">Estiagem</option>
          <option value="Enchente">Enchente</option>
          <option value="Incêndio">Incêndio</option>
        </select>
      </div>
      <script>
        const motivoAuxilioChoices = new Choices('#motivoAuxilio', {
          removeItemButton: true,
          placeholderValue: 'Selecione os motivos',
          searchEnabled: false
        });
      </script>
      <div class="col-12 d-flex justify-content-center gap-2 mt-3">
        <button type="button" class="btn btn-primary" onclick="adicionarFicha()">Salvar</button>
        <button type="button" class="btn btn-secondary" onclick="window.location.href='fichacafa.html'">Registros</button>
        <button type="button" class="btn btn-warning" onclick="abrirModalComunidades()">Gerenciar Comunidades</button>
      </div>
    </form>
  </main>
  <!-- Modal para Gerenciar Comunidades -->
  <div class="modal" id="modalComunidades">
    <div class="modal-content">
      <button class="close-modal" onclick="fecharModalComunidades()">×</button>
      <h2>Gerenciar Comunidades</h2>
      <ul class="comunidade-lista" id="comunidadeLista"></ul>
    </div>
  </div>
  <!-- Overlay de Carregamento -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="spinner"></div>
  </div>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyC5wHhdIZlY9txtYkN88R-67lIP5FZlFpY",
      authDomain: "mtag-1c04d.firebaseapp.com",
      projectId: "mtag-1c04d",
      storageBucket: "mtag-1c04d.firebasestorage.app",
      messagingSenderId: "487741931549",
      appId: "1:487741931549:web:cf45afe3c7b5cda7de06f4"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const secoesValidas = [
      '001', '002', '003', '004', '005', '006', '007', '008', '009', '010',
      '011', '012', '021', '022', '023', '029', '030', '031', '047', '048',
      '049', '050', '063', '064', '065', '073', '075', '078', '080', '081',
      '082', '083', '085', '091', '094', '095', '096', '097', '098', '099',
      '100', '101', '102', '103', '104', '105', '106', '107', '108', '109',
      '110', '111', '112', '113', '115', '116', '117', '118', '119', '120',
      '121', '122', '123', '124', '125', '126', '127', '128', '129', '130',
      '131', '132', '133', '134', '135', '136', '137', '138', '139', '140',
      '141', '142', '143', '188', '189', '190', '192', '193', '194', '195',
      '197', '199', '200', '201', '202', '203', '205', '208', '209', '210',
      '211', '212'
    ];

    let comunidadesOriginal = [];

    function ajustarTamanhoSelect() {
      const motivoAuxilio = document.getElementById('motivoAuxilio');
      const numOpcoes = motivoAuxilio.options.length;
      motivoAuxilio.setAttribute('size', numOpcoes);
    }

    async function carregarLocalidades(filtro = '') {
      const select = document.getElementById("localidadeSelect");
      select.innerHTML = `<option value="">Selecione uma comunidade</option>`;
      comunidadesOriginal = [];
      
      const snapshot = await db.collection("comunidades").orderBy("nome").get();
      snapshot.forEach(doc => {
        const nome = doc.data().nome;
        comunidadesOriginal.push({ id: doc.id, nome });
      });

      const comunidadesFiltradas = comunidadesOriginal.filter(com =>
        com.nome.toLowerCase().includes(filtro.toLowerCase())
      );

      comunidadesFiltradas.forEach(com => {
        const option = document.createElement("option");
        option.value = com.nome;
        option.textContent = com.nome;
        select.appendChild(option);
      });
    }

    async function adicionarLocalidade() {
      const nova = document.getElementById("novaLocalidade").value.trim().toUpperCase();
      if (!nova) return alert("Informe o nome da nova comunidade.");
      const existente = await db.collection("comunidades").where("nome", "==", nova).get();
      if (!existente.empty) return alert("Essa comunidade já existe.");

      await db.collection("comunidades").add({ nome: nova });
      alert("Comunidade adicionada com sucesso.");
      document.getElementById("novaLocalidade").value = "";
      carregarLocalidades(document.getElementById("buscaComunidade").value);
    }

    async function carregarComunidadesModal() {
      const lista = document.getElementById("comunidadeLista");
      lista.innerHTML = "";
      const snapshot = await db.collection("comunidades").orderBy("nome").get();
      snapshot.forEach(doc => {
        const li = document.createElement("li");
        li.className = "comunidade-item";
        li.innerHTML = `
          <span>${doc.data().nome}</span>
          <button class="btn-editar" onclick="editarComunidade('${doc.id}', '${doc.data().nome}')">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#2563eb" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
              <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
            </svg>
          </button>
          <button class="btn-excluir" onclick="excluirComunidade('${doc.id}')">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#dc2626" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="3 6 5 6 21 6"/>
              <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
              <line x1="10" y1="11" x2="10" y2="17"/>
              <line x1="14" y1="11" x2="14" y2="17"/>
            </svg>
          </button>
        `;
        lista.appendChild(li);
      });
    }

    function abrirModalComunidades() {
      document.getElementById("modalComunidades").style.display = "flex";
      carregarComunidadesModal();
    }

    function fecharModalComunidades() {
      document.getElementById("modalComunidades").style.display = "none";
    }

    async function editarComunidade(id, nomeAtual) {
      const novoNome = prompt("Editar nome da comunidade:", nomeAtual);
      if (novoNome && novoNome.trim() && novoNome.trim().toUpperCase() !== nomeAtual) {
        const existente = await db.collection("comunidades").where("nome", "==", novoNome.trim().toUpperCase()).get();
        if (!existente.empty) {
          alert("Já existe uma comunidade com esse nome.");
          return;
        }
        await db.collection("comunidades").doc(id).update({ nome: novoNome.trim().toUpperCase() });
        alert("Comunidade atualizada com sucesso.");
        carregarComunidadesModal();
        carregarLocalidades(document.getElementById("buscaComunidade").value);
      }
    }

    async function excluirComunidade(id) {
      if (confirm("Tem certeza que deseja excluir esta comunidade?")) {
        await db.collection("comunidades").doc(id).delete();
        alert("Comunidade excluída com sucesso.");
        carregarComunidadesModal();
        carregarLocalidades(document.getElementById("buscaComunidade").value);
      }
    }

    window.onload = () => {
      carregarLocalidades();
      ajustarTamanhoSelect();
      const buscaComunidade = document.getElementById("buscaComunidade");
      let debounceTimeout;
      buscaComunidade.addEventListener("input", (e) => {
        clearTimeout(debounceTimeout);
        debounceTimeout = setTimeout(() => {
          carregarLocalidades(e.target.value);
        }, 300); // Debounce de 300ms
      });
    };

    function mascaraCPF(input) {
      let v = input.value.replace(/\D/g, "").slice(0, 11);
      v = v.replace(/(\d{3})(\d)/, "$1.$2");
      v = v.replace(/(\d{3})(\d)/, "$1.$2");
      v = v.replace(/(\d{3})(\d{1,2})$/, "$1-$2");
      input.value = v;
      validarCPFRealTime(input);
    }

    function mascaraTitulo(input) {
      let v = input.value.replace(/\D/g, "").slice(0, 12);
      v = v.replace(/(\d{4})(\d{4})(\d{0,4})/, "$1 $2 $3").trim();
      input.value = v;
    }

    function mascaraTelefone(input) {
      let v = input.value.replace(/\D/g, "").slice(0, 11);
      if (v.length >= 11) {
        input.value = v.replace(/^(\d{2})(\d{5})(\d{4})$/, "($1) $2-$3");
      } else {
        input.value = v.replace(/^(\d{2})(\d{4,5})?(\d{0,4})?/, (match, p1, p2, p3) => {
          let res = `(${p1}`;
          if (p2) res += `) ${p2}`;
          if (p3) res += `-${p3}`;
          return res;
        });
      }
    }

    function mascaraData(input) {
      let v = input.value.replace(/\D/g, "").slice(0, 8);
      v = v.replace(/(\d{2})(\d)/, "$1/$2");
      v = v.replace(/(\d{2})\/(\d{2})(\d)/, "$1/$2/$3");
      input.value = v;
    }

    function validarCPF(cpf) {
      cpf = cpf.replace(/[^\d]+/g, '');
      if (cpf.length !== 11 || /^(\d)\1+$/.test(cpf)) return false;
      let soma = 0;
      for (let i = 0; i < 9; i++) soma += parseInt(cpf.charAt(i)) * (10 - i);
      let resto = 11 - (soma % 11);
      if (resto >= 10) resto = 0;
      if (resto !== parseInt(cpf.charAt(9))) return false;
      soma = 0;
      for (let i = 0; i < 10; i++) soma += parseInt(cpf.charAt(i)) * (11 - i);
      resto = 11 - (soma % 11);
      if (resto >= 10) resto = 0;
      return resto === parseInt(cpf.charAt(10));
    }

    async function verificarCPFDuplicado(cpf, inputId) {
      const snapshotLider = await db.collection('fichas_acaoexecutada').where('cpfLider', '==', cpf).get();
      const snapshotEsposa = await db.collection('fichas_acaoexecutada').where('cpfEsposa', '==', cpf).get();
      return !snapshotLider.empty || !snapshotEsposa.empty;
    }

    async function validarCPFRealTime(input) {
      const cpf = input.value;
      const feedbackElement = document.getElementById(input.id + 'Feedback');
      feedbackElement.textContent = '';
      feedbackElement.className = 'cpf-feedback';

      if (cpf.length === 14) {
        if (!validarCPF(cpf)) {
          feedbackElement.textContent = 'CPF inválido';
          feedbackElement.className = 'cpf-feedback cpf-invalido';
        } else {
          const isDuplicado = await verificarCPFDuplicado(cpf, input.id);
          if (isDuplicado) {
            feedbackElement.textContent = 'CPF já cadastrado';
            feedbackElement.className = 'cpf-feedback cpf-duplicado';
          } else {
            feedbackElement.textContent = 'CPF válido';
            feedbackElement.className = 'cpf-feedback cpf-valido';
          }
        }
      }
    }

    function calcularIdade(input) {
      const data = input.value;
      const feedbackElement = document.getElementById('idadeFeedback');
      if (data.length === 10 && /^\d{2}\/\d{2}\/\d{4}$/.test(data)) {
        const [dia, mes, ano] = data.split('/').map(Number);
        const hoje = new Date();
        let idade = hoje.getFullYear() - ano;
        const mesAtual = hoje.getMonth() + 1;
        const diaAtual = hoje.getDate();
        if (mesAtual < mes || (mesAtual === mes && diaAtual < dia)) {
          idade--;
        }
        feedbackElement.textContent = idade >= 0 ? `Idade: ${idade} anos` : 'Data de nascimento inválida';
        feedbackElement.className = 'idade-feedback';
      } else {
        feedbackElement.textContent = '';
        feedbackElement.className = 'idade-feedback';
      }
    }

    function validarSecao(input) {
      let v = input.value.replace(/\D/g, "").slice(0, 3);
      input.value = v;
      const feedbackElement = document.getElementById(input.id + 'Feedback');
      if (v.length === 3) {
        if (secoesValidas.includes(v)) {
          feedbackElement.textContent = 'Seção válida';
          feedbackElement.className = 'secao-feedback secao-valido';
        } else {
          feedbackElement.textContent = 'Seção inválida';
          feedbackElement.className = 'secao-feedback secao-invalido';
        }
      } else {
        feedbackElement.textContent = '';
        feedbackElement.className = 'secao-feedback';
      }
    }

    function validarZona(input) {
      let v = input.value.replace(/\D/g, "").slice(0, 4);
      input.value = v;
      const feedbackElement = document.getElementById(input.id + 'Feedback');
      if (v.length === 4) {
        if (v === '0023') {
          feedbackElement.textContent = 'Zona válida';
          feedbackElement.className = 'zona-feedback zona-valido';
        } else {
          feedbackElement.textContent = 'Zona inválida (deve ser 0023)';
          feedbackElement.className = 'zona-feedback zona-invalido';
        }
      } else {
        feedbackElement.textContent = '';
        feedbackElement.className = 'zona-feedback';
      }
    }

    function forcarMaiusculas(input) {
      input.value = input.value.toUpperCase();
    }

    document.querySelectorAll('input[type="text"]').forEach(input => {
      input.addEventListener('input', () => forcarMaiusculas(input));
    });

    document.querySelectorAll('input, select').forEach((element, index, elements) => {
      element.addEventListener('keydown', (event) => {
        if (event.key === 'Enter') {
          event.preventDefault();
          const nextElement = elements[index + 1];
          if (nextElement) {
            nextElement.focus();
          } else {
            document.querySelector('.btn-primary').focus();
          }
        }
      });
    });

    async function adicionarFicha() {
      const btnSalvar = document.querySelector('.btn-primary');
      btnSalvar.disabled = true;
      document.getElementById('loadingOverlay').style.display = 'flex';

      try {
        const liderFamilia = document.getElementById('liderFamilia').value.trim();
        const cpfLider = document.getElementById('cpfLider').value.trim();
        const numeroContato = document.getElementById('numeroContato').value.trim();
        const dataNascimentoLider = document.getElementById('dataNascimentoLider').value.trim();
        const tituloEleitorLider = document.getElementById('tituloEleitorLider').value.trim();
        const zonaLider = document.getElementById('zonaLider').value.trim();
        const secaoLider = document.getElementById('secaoLider').value.trim();
        const nomeEsposa = document.getElementById('nomeEsposa').value.trim();
        const cpfEsposa = document.getElementById('cpfEsposa').value.trim();
        const tituloEleitorEsposa = document.getElementById('tituloEleitorEsposa').value.trim();
        const zonaEsposa = document.getElementById('zonaEsposa').value.trim();
        const secaoEsposa = document.getElementById('secaoEsposa').value.trim();
        const filhos = document.getElementById('filhos').value.trim();
        const localidade = document.getElementById('localidadeSelect').value;
        const motivoAuxilio = Array.from(document.getElementById('motivoAuxilio').selectedOptions).map(option => option.value);

        if (!liderFamilia || !cpfLider || !tituloEleitorLider || !zonaLider || !secaoLider || !localidade || !motivoAuxilio.length) {
          alert('Preencha todos os campos obrigatórios: Líder de Família, CPF do Líder, Título de Eleitor do Líder, Zona do Líder, Seção do Líder, Comunidade e Motivo do Auxílio.');
          return;
        }

        if (!validarCPF(cpfLider)) {
          alert('CPF do líder inválido.');
          return;
        }

        const snapshot = await db.collection('fichas_acaoexecutada').where('cpfLider', '==', cpfLider).get();
        if (!snapshot.empty) {
          alert('CPF do líder já cadastrado.');
          return;
        }

        if (cpfEsposa && !validarCPF(cpfEsposa)) {
          alert('CPF do(a) cônjuge inválido.');
          return;
        }

        if (zonaLider !== '0023') {
          alert('Zona do líder inválida (deve ser 0023).');
          return;
        }

        if (secaoLider && !secoesValidas.includes(secaoLider)) {
          alert('Seção do líder inválida.');
          return;
        }

        if (zonaEsposa && zonaEsposa !== '0023') {
          alert('Zona do(a) cônjuge inválida (deve ser 0023).');
          return;
        }

        if (secaoEsposa && !secoesValidas.includes(secaoEsposa)) {
          alert('Seção do(a) cônjuge inválida.');
          return;
        }

        await db.collection('fichas_acaoexecutada').add({
          liderFamilia,
          cpfLider,
          numeroContato: numeroContato || null,
          dataNascimentoLider: dataNascimentoLider || null,
          tituloEleitorLider: tituloEleitorLider || null,
          zonaLider: zonaLider || null,
          secaoLider: secaoLider || null,
          nomeEsposa: nomeEsposa || null,
          cpfEsposa: cpfEsposa || null,
          tituloEleitorEsposa: tituloEleitorEsposa || null,
          zonaEsposa: zonaEsposa || null,
          secaoEsposa: secaoEsposa || null,
          filhos: filhos || null,
          localidade,
          motivoAuxilio,
          timestamp: firebase.firestore.FieldValue.serverTimestamp(),
        });

        alert('Ficha salva com sucesso!');
        document.querySelectorAll("input").forEach(el => el.value = '');
        document.getElementById("localidadeSelect").value = "";
        motivoAuxilioChoices.clearStore();
        motivoAuxilioChoices.setChoices([
          { value: 'Estiagem', label: 'Estiagem' },
          { value: 'Enchente', label: 'Enchente' },
          { value: 'Incêndio', label: 'Incêndio' }
        ], 'value', 'label', false);
        document.getElementById("cpfLiderFeedback").textContent = '';
        document.getElementById("cpfEsposaFeedback").textContent = '';
        document.getElementById("secaoLiderFeedback").textContent = '';
        document.getElementById("secaoEsposaFeedback").textContent = '';
        document.getElementById("zonaLiderFeedback").textContent = '';
        document.getElementById("zonaEsposaFeedback").textContent = '';
        document.getElementById("idadeFeedback").textContent = '';
        ajustarTamanhoSelect();
      } catch (error) {
        console.error('Erro ao salvar ficha:', error);
        alert('Erro ao salvar ficha. Veja o console para mais detalhes.');
      } finally {
        btnSalvar.disabled = false;
        document.getElementById('loadingOverlay').style.display = 'none';
      }
    }
  </script>
  <!-- Bootstrap JS CDN (opcional, mas útil para modais e outros componentes) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
</body>
</html>